<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>Test Upload - Dashboard Effe</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0051cc;
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .success { color: #0a0; background: #efe; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #e00; background: #fee; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Upload Vendite</h1>
        <p>Questo tool testa l'upload di vendite direttamente alle Edge Functions.</p>

        <h3>Step 1: Test Vendite Dummy</h3>
        <button onclick="testUploadDummy()">üì§ Invia 3 Vendite di Test</button>

        <h3>Step 2: Verifica Database</h3>
        <button onclick="checkDatabase()">üîç Conta Vendite nel Database</button>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://sbtkymupbjyikfwjeumk.supabase.co/functions/v1/make-server-49468be0';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNidGt5bXVwYmp5aWtmd2pldW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDA0MTUsImV4cCI6MjA3NDQ3NjQxNX0.ONl5r0x89QJKQtP9jttBkvESpV6lDpc1ijydxtP7nzo';

        function showResult(html) {
            document.getElementById('results').innerHTML += html;
        }

        async function testUploadDummy() {
            showResult('<p>‚è≥ Invio 3 vendite di test...</p>');

            const testSales = [
                {
                    date: new Date('2024-01-15').toISOString(),
                    user: 'carla',
                    channel: 'negozio_donna',
                    sku: 'PROD-DONNA-001',
                    productId: 'PROD-DONNA-001',
                    quantity: 2,
                    price: 150.00,
                    amount: 300.00,
                    brand: 'Brand Test',
                    category: 'abbigliamento',
                    season: 'autunno_inverno'
                },
                {
                    date: new Date('2024-01-16').toISOString(),
                    user: 'alexander',
                    channel: 'negozio_uomo',
                    sku: 'PROD-UOMO-001',
                    productId: 'PROD-UOMO-001',
                    quantity: 1,
                    price: 200.00,
                    amount: 200.00,
                    brand: 'Brand Test',
                    category: 'abbigliamento',
                    season: 'autunno_inverno'
                },
                {
                    date: new Date('2024-01-17').toISOString(),
                    user: 'paolo',
                    channel: 'negozio_uomo',
                    sku: 'PROD-UOMO-002',
                    productId: 'PROD-UOMO-002',
                    quantity: 3,
                    price: 50.00,
                    amount: 150.00,
                    brand: 'Brand Test',
                    category: 'accessori',
                    season: 'autunno_inverno'
                }
            ];

            try {
                const response = await fetch(`${API_BASE}/sales/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sales: testSales })
                });

                const data = await response.json();

                if (data.success) {
                    showResult(`
                        <div class="success">
                            <strong>‚úÖ Upload riuscito!</strong><br>
                            Salvate: ${data.savedCount || 0} vendite<br>
                            Duplicate saltate: ${data.skippedDuplicates || 0}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                } else {
                    showResult(`
                        <div class="error">
                            <strong>‚ùå Upload fallito!</strong><br>
                            ${data.error || 'Errore sconosciuto'}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                }
            } catch (error) {
                showResult(`
                    <div class="error">
                        <strong>‚ùå Errore di connessione!</strong><br>
                        ${error.message}<br>
                        <em>Possibile problema CORS? Verifica che le Edge Functions siano state ridistribuite.</em>
                    </div>
                `);
            }
        }

        async function checkDatabase() {
            showResult('<p>‚è≥ Verifica database...</p>');

            try {
                const response = await fetch(`${API_BASE}/sales`, {
                    headers: {
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const sales = data.data || [];
                    const byChannel = {
                        negozio_donna: sales.filter(s => s.channel === 'negozio_donna'),
                        negozio_uomo: sales.filter(s => s.channel === 'negozio_uomo'),
                        ecommerce: sales.filter(s => s.channel === 'ecommerce'),
                        marketplace: sales.filter(s => s.channel === 'marketplace')
                    };

                    showResult(`
                        <div class="success">
                            <strong>‚úÖ Database check completato!</strong><br>
                            <strong>Totale vendite:</strong> ${sales.length}<br><br>
                            <strong>Per canale:</strong><br>
                            ‚Ä¢ Negozio Donna: ${byChannel.negozio_donna.length} vendite<br>
                            ‚Ä¢ Negozio Uomo: ${byChannel.negozio_uomo.length} vendite<br>
                            ‚Ä¢ E-commerce: ${byChannel.ecommerce.length} vendite<br>
                            ‚Ä¢ Marketplace: ${byChannel.marketplace.length} vendite<br>
                            <br>
                            <details>
                                <summary style="cursor: pointer; font-weight: bold;">Vedi tutte le vendite (click per espandere)</summary>
                                <pre>${JSON.stringify(sales, null, 2)}</pre>
                            </details>
                        </div>
                    `);
                } else {
                    showResult(`
                        <div class="error">
                            <strong>‚ùå Errore nel database check!</strong><br>
                            ${data.error || 'Errore sconosciuto'}
                        </div>
                    `);
                }
            } catch (error) {
                showResult(`
                    <div class="error">
                        <strong>‚ùå Errore di connessione!</strong><br>
                        ${error.message}
                    </div>
                `);
            }
        }

        // Auto-check on load
        window.onload = () => {
            checkDatabase();
        };
    </script>
</body>
</html>
