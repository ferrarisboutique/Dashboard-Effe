# Architecture Notes & Future Improvements

## Current Architecture

### Edge Functions
- **Name**: `make-server-49468be0` (auto-generated by Figma Make)
- **Storage**: Single KV table `kv_store_49468be0` for all data
- **Routes**:
  - `/sales/*` - Sales data operations
  - `/inventory/*` - Inventory management
  - `/health` - Health check endpoint

### Data Storage Strategy
Currently using **KV Store (JSON)** for both sales and inventory:
- **Pros**: Schema-less, flexible, fast prototyping
- **Cons**: Less efficient for large datasets, complex queries require full scan

## Future Improvements

### 1. Rename Edge Function (Recommended)

**Current**: `make-server-49468be0`  
**Suggested**: `dashboard-api`

**Steps to rename:**

1. **Create new function folder**:
   ```bash
   cp -r supabase/functions/make-server-49468be0 supabase/functions/dashboard-api
   ```

2. **Update index.ts route prefix**:
   ```typescript
   // Old: app.route("/make-server-49468be0", salesRoutes);
   // New: app.route("/dashboard-api", salesRoutes);
   ```

3. **Keep using same KV table** (to preserve data):
   ```typescript
   // In kv_store.ts, keep using:
   supabase.from("kv_store_49468be0")
   ```

4. **Update frontend API_BASE_URL**:
   ```typescript
   // src/utils/supabase/info.tsx
   export const API_BASE_URL = `${supabaseUrl}/functions/v1/dashboard-api`;
   ```

5. **Deploy new function**:
   ```bash
   npx supabase functions deploy dashboard-api --no-verify-jwt
   ```

6. **Test thoroughly**, then delete old function:
   ```bash
   npx supabase functions delete make-server-49468be0
   ```

**Risk**: If something goes wrong, you can always redeploy the old function. The data remains safe in `kv_store_49468be0`.

### 2. Migrate to SQL Tables (Future)

**Benefits**:
- Efficient queries (WHERE, JOIN, indexes)
- Type-safe schema
- Better performance at scale
- Built-in Supabase features (RLS, real-time, etc.)

**Suggested schema**:

```sql
-- Sales table
CREATE TABLE sales (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  date TIMESTAMP WITH TIME ZONE NOT NULL,
  user TEXT,
  channel TEXT NOT NULL CHECK (channel IN ('negozio_donna', 'negozio_uomo', 'ecommerce', 'marketplace')),
  sku TEXT NOT NULL,
  product_id TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  price DECIMAL(10,2),
  amount DECIMAL(10,2) NOT NULL,
  brand TEXT,
  category TEXT,
  season TEXT,
  marketplace TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_sales_date ON sales(date);
CREATE INDEX idx_sales_channel ON sales(channel);
CREATE INDEX idx_sales_brand ON sales(brand);
CREATE INDEX idx_sales_sku ON sales(sku);

-- Inventory table
CREATE TABLE inventory (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sku TEXT UNIQUE NOT NULL,
  category TEXT NOT NULL,
  brand TEXT NOT NULL,
  purchase_price DECIMAL(10,2) NOT NULL,
  sell_price DECIMAL(10,2) NOT NULL,
  collection TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_inventory_sku ON inventory(sku);
CREATE INDEX idx_inventory_brand ON inventory(brand);

-- Learned mappings table
CREATE TABLE mappings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  mapping_type TEXT NOT NULL CHECK (mapping_type IN ('brand', 'channel')),
  key TEXT NOT NULL,
  value TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(mapping_type, key)
);
```

**Migration strategy**:
1. Create new tables
2. Write migration script to copy data from KV to SQL
3. Update Edge Functions to use `supabase.from('sales')` instead of KV
4. Deploy and test with parallel writes (both KV and SQL) initially
5. Once stable, remove KV code and drop old table

**Timeline**: Implement when dataset grows beyond 100k records or query performance becomes an issue.

### 3. Additional Optimizations

- **Caching**: Add Redis/Upstash for frequently accessed data
- **Pagination**: Already implemented for inventory; ensure sales endpoints support it
- **Search**: Add full-text search for SKU/brand lookups
- **Analytics**: Pre-compute aggregates (daily/monthly totals) in separate tables
- **Monitoring**: Integrate Sentry alerts for Edge Function errors
- **Rate Limiting**: Add rate limiting to prevent abuse

## Health Check & Debugging

### Test health endpoint:
```bash
curl https://sbtkymupbjyikfwjeumk.supabase.co/functions/v1/make-server-49468be0/health
```

Expected response:
```json
{
  "status": "ok",
  "timestamp": "2025-01-..."
}
```

### View Edge Function logs:
```bash
npx supabase functions logs make-server-49468be0
```

### Common issues:
- **CORS errors**: Check `cors()` middleware in index.ts
- **Timeout errors**: Edge Functions have 50s limit; optimize queries or split operations
- **Module not found**: Ensure imports use correct extensions (.ts not .tsx)

## Notes

- Current implementation is **production-ready** for current scale
- KV approach works well for < 100k records
- Monitor performance and migrate to SQL when needed
- Keep backward compatibility during migrations
