<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Database - Dashboard Effe</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0051cc;
        }
        button.danger {
            background: #e00;
        }
        button.danger:hover {
            background: #c00;
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #e00;
            background: #fee;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            color: #0a0;
            background: #efe;
            padding: 10px;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: 600;
        }
        .channel-donna { color: #e91e63; font-weight: bold; }
        .channel-uomo { color: #2196f3; font-weight: bold; }
        .channel-ecommerce { color: #4caf50; font-weight: bold; }
        .channel-marketplace { color: #ff9800; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Database - Dashboard Effe</h1>
        <p>Strumento di debug per verificare lo stato del database e delle vendite.</p>
    </div>

    <div class="container">
        <h2>üìä Statistiche Database</h2>
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Totale Vendite</h3>
                <div class="value" id="total-sales">-</div>
            </div>
            <div class="stat-card">
                <h3>Vendite Negozio Donna</h3>
                <div class="value" id="donna-sales">-</div>
            </div>
            <div class="stat-card">
                <h3>Vendite Negozio Uomo</h3>
                <div class="value" id="uomo-sales">-</div>
            </div>
            <div class="stat-card">
                <h3>Inventario</h3>
                <div class="value" id="inventory-count">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Azioni</h2>
        <button onclick="checkHealth()">üè• Health Check</button>
        <button onclick="fetchAllSales()">üì• Carica Tutte le Vendite</button>
        <button onclick="fetchSalesByChannel()">üè™ Vendite per Canale</button>
        <button onclick="testUpload()">üß™ Test Upload (Vendita Dummy)</button>
        <button onclick="checkCORS()">üåê Test CORS</button>
    </div>

    <div class="container">
        <h2>üìã Risultati</h2>
        <div id="results"><p class="loading">Clicca su un pulsante per iniziare...</p></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sbtkymupbjyikfwjeumk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNidGt5bXVwYmp5aWtmd2pldW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDA0MTUsImV4cCI6MjA3NDQ3NjQxNX0.ONl5r0x89QJKQtP9jttBkvESpV6lDpc1ijydxtP7nzo';
        const API_BASE = `${SUPABASE_URL}/functions/v1/make-server-49468be0`;

        function showResult(html) {
            document.getElementById('results').innerHTML = html;
        }

        function showLoading(message = 'Caricamento...') {
            showResult(`<p class="loading">${message}</p>`);
        }

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            console.log(`üîµ API Call: ${options.method || 'GET'} ${url}`);
            const response = await fetch(url, config);
            const data = await response.json();
            console.log(`üü¢ Response:`, data);
            return { response, data };
        }

        async function checkHealth() {
            showLoading('Verifico lo stato del server...');
            try {
                const { response, data } = await apiCall('/health');
                if (data.status === 'ok') {
                    showResult(`
                        <div class="success">
                            <strong>‚úÖ Server Online!</strong><br>
                            Timestamp: ${data.timestamp}<br>
                            Message: ${data.message}
                        </div>
                    `);
                } else {
                    showResult(`<div class="error">‚ùå Server Error: ${JSON.stringify(data)}</div>`);
                }
            } catch (error) {
                showResult(`<div class="error">‚ùå Errore: ${error.message}</div>`);
            }
        }

        async function fetchAllSales() {
            showLoading('Carico tutte le vendite dal database...');
            try {
                const { response, data } = await apiCall('/sales');

                if (!data.success) {
                    showResult(`<div class="error">‚ùå Errore: ${data.error}</div>`);
                    return;
                }

                const sales = data.data || [];

                // Update stats
                document.getElementById('total-sales').textContent = sales.length;
                const donnaSales = sales.filter(s => s.channel === 'negozio_donna').length;
                const uomoSales = sales.filter(s => s.channel === 'negozio_uomo').length;
                document.getElementById('donna-sales').textContent = donnaSales;
                document.getElementById('uomo-sales').textContent = uomoSales;

                if (sales.length === 0) {
                    showResult(`
                        <div class="error">
                            <strong>‚ö†Ô∏è Nessuna vendita trovata nel database!</strong><br>
                            Il database √® vuoto. Prova a caricare un file di vendite.
                        </div>
                    `);
                    return;
                }

                // Show first 20 sales
                let html = `
                    <div class="success">
                        <strong>‚úÖ Trovate ${sales.length} vendite nel database</strong>
                    </div>
                    <h3>Prime 20 vendite:</h3>
                    <table>
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Canale</th>
                            <th>Utente</th>
                            <th>SKU</th>
                            <th>Quantit√†</th>
                            <th>Importo</th>
                        </tr>
                `;

                sales.slice(0, 20).forEach(sale => {
                    const channelClass = `channel-${sale.channel.replace('_', '-')}`;
                    const date = new Date(sale.date).toLocaleDateString('it-IT');
                    html += `
                        <tr>
                            <td><code>${sale.id.substring(0, 20)}...</code></td>
                            <td>${date}</td>
                            <td class="${channelClass}">${sale.channel}</td>
                            <td>${sale.user || '-'}</td>
                            <td><code>${sale.sku || sale.productId || '-'}</code></td>
                            <td>${sale.quantity || '-'}</td>
                            <td>‚Ç¨${(sale.amount || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });

                html += `</table>`;
                if (sales.length > 20) {
                    html += `<p><em>... e altre ${sales.length - 20} vendite</em></p>`;
                }

                showResult(html);
            } catch (error) {
                showResult(`<div class="error">‚ùå Errore: ${error.message}</div>`);
            }
        }

        async function fetchSalesByChannel() {
            showLoading('Analizzo le vendite per canale...');
            try {
                const { response, data } = await apiCall('/sales');

                if (!data.success) {
                    showResult(`<div class="error">‚ùå Errore: ${data.error}</div>`);
                    return;
                }

                const sales = data.data || [];

                const byChannel = {
                    negozio_donna: [],
                    negozio_uomo: [],
                    ecommerce: [],
                    marketplace: [],
                    other: []
                };

                sales.forEach(sale => {
                    const channel = sale.channel;
                    if (byChannel[channel]) {
                        byChannel[channel].push(sale);
                    } else {
                        byChannel.other.push(sale);
                    }
                });

                let html = `
                    <h3>üìä Analisi per Canale</h3>
                    <table>
                        <tr>
                            <th>Canale</th>
                            <th>Numero Vendite</th>
                            <th>Importo Totale</th>
                        </tr>
                `;

                Object.entries(byChannel).forEach(([channel, salesList]) => {
                    if (salesList.length > 0) {
                        const total = salesList.reduce((sum, s) => sum + (s.amount || 0), 0);
                        const channelClass = `channel-${channel.replace('_', '-')}`;
                        html += `
                            <tr>
                                <td class="${channelClass}">${channel}</td>
                                <td>${salesList.length}</td>
                                <td>‚Ç¨${total.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                });

                html += `</table>`;

                // Show sample sales for negozio_donna and negozio_uomo
                ['negozio_donna', 'negozio_uomo'].forEach(channel => {
                    const channelSales = byChannel[channel];
                    if (channelSales.length > 0) {
                        html += `
                            <h3>Esempio vendite ${channel}:</h3>
                            <pre>${JSON.stringify(channelSales.slice(0, 3), null, 2)}</pre>
                        `;
                    } else {
                        html += `
                            <div class="error">
                                <strong>‚ö†Ô∏è Nessuna vendita trovata per ${channel}!</strong>
                            </div>
                        `;
                    }
                });

                showResult(html);
            } catch (error) {
                showResult(`<div class="error">‚ùå Errore: ${error.message}</div>`);
            }
        }

        async function testUpload() {
            showLoading('Invio una vendita di test...');
            try {
                const testSale = {
                    date: new Date().toISOString(),
                    user: 'carla',
                    channel: 'negozio_donna',
                    sku: 'TEST-001',
                    productId: 'TEST-001',
                    quantity: 1,
                    price: 99.99,
                    amount: 99.99,
                    brand: 'TEST-BRAND',
                    category: 'abbigliamento',
                    season: 'autunno_inverno'
                };

                const { response, data } = await apiCall('/sales/bulk', {
                    method: 'POST',
                    body: JSON.stringify({ sales: [testSale] })
                });

                if (data.success) {
                    showResult(`
                        <div class="success">
                            <strong>‚úÖ Upload riuscito!</strong><br>
                            Vendite salvate: ${data.savedCount || 1}<br>
                            Duplicate saltate: ${data.skippedDuplicates || 0}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <button onclick="fetchAllSales()">üîÑ Ricarica Vendite</button>
                    `);
                } else {
                    showResult(`<div class="error">‚ùå Upload fallito: ${data.error}</div>`);
                }
            } catch (error) {
                showResult(`<div class="error">‚ùå Errore: ${error.message}</div>`);
            }
        }

        async function checkCORS() {
            showLoading('Verifico CORS...');
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                showResult(`
                    <div class="success">
                        <strong>‚úÖ CORS Headers:</strong>
                        <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                    </div>
                `);
            } catch (error) {
                showResult(`<div class="error">‚ùå Errore CORS: ${error.message}</div>`);
            }
        }

        // Auto-load stats on page load
        window.onload = async () => {
            await checkHealth();
            try {
                const { data } = await apiCall('/sales');
                if (data.success && data.data) {
                    const sales = data.data;
                    document.getElementById('total-sales').textContent = sales.length;
                    document.getElementById('donna-sales').textContent =
                        sales.filter(s => s.channel === 'negozio_donna').length;
                    document.getElementById('uomo-sales').textContent =
                        sales.filter(s => s.channel === 'negozio_uomo').length;
                }

                const { data: invData } = await apiCall('/inventory/count');
                if (invData.success) {
                    document.getElementById('inventory-count').textContent = invData.count;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        };
    </script>
</body>
</html>
